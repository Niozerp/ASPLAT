<script src="js/templates.js"></script>

  <main id="app" class="container-lg py-4">
    <div class="row g-4">
      <!-- Editor -->
      <section class="col-lg-6">
        <div class="card border-secondary-subtle h-100">
          <div class="card-header d-flex align-items-center justify-content-between">
            <span>Editor</span>
            <span class="text-body-secondary small">Press <kbd>Ctrl</kbd>+<kbd>Enter</kbd> to render</span>
          </div>
          <div class="card-body">
            <label for="src" class="form-label">Diagram source</label>
            <textarea id="src" class="form-control" rows="14" v-model="source" spellcheck="false"></textarea>
            <div class="d-flex flex-wrap gap-2 mt-3">
              <button type="button" class="btn btn-primary" @click="render">Render</button>
              <button type="button" class="btn btn-outline-secondary" @click="reset">Reset</button>
              <button type="button" class="btn btn-outline-light" @click="copy">Copy SVG</button>
              <button type="button" class="btn btn-outline-light" @click="download">Download SVG</button>
            </div>
            <div v-if="error" class="alert alert-danger mt-3 mb-0">
              <strong>Render error:</strong> {{ error }}
            </div>
          </div>
        </div>
      </section>

      <!-- Preview -->
      <section class="col-lg-6">
        <div class="card border-secondary-subtle h-100">
          <div class="card-header d-flex align-items-center justify-content-between">
            <span>Preview</span>
            <span class="badge text-bg-secondary">Dark theme</span>
          </div>
          <div class="card-body">
            <div ref="diagram" class="mermaid-diagram" v-html="svg"></div>
            <p class="text-body-secondary small mt-2 mb-0">Tip: keep node text short; prefer one decision per lane.</p>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Vue 2.5 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.5.22/dist/vue.min.js"></script>

  <!-- Mermaid (ESM) orchestrated from a module so we can use the modern render API) -->
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

    // Configure Mermaid for manual control and dark visuals
    mermaid.initialize({ startOnLoad: false, theme: 'dark' });

    const DEFAULT_SRC = `flowchart TD\n    A([Start]) --> B[Define objective]\n    B --> C[List steps]\n    C --> D{Decision?}\n    D -- Yes --> E[Branch A]\n    D -- No  --> F[Branch B]\n    E --> G{More steps?}\n    F --> G\n    G -- Yes --> C\n    G -- No  --> H([End])`;

    // Create Vue app
    const app = new window.Vue({
      el: '#app',
      data() {
        return {
          source: DEFAULT_SRC,
          svg: '',
          error: ''
        };
      },
      methods: {
        async render() {
          this.error = '';
          const def = (this.source || '').trim();
          if (!def) { this.svg = ''; return; }
          try {
            const { svg, bindFunctions } = await mermaid.render('mmd-' + Math.random().toString(36).slice(2), def);
            this.svg = svg;
            this.$nextTick(() => { if (typeof bindFunctions === 'function') bindFunctions(this.$refs.diagram); });
          } catch (e) {
            this.error = e && e.message ? e.message : String(e);
          }
        },
        reset() {
          this.source = DEFAULT_SRC;
          this.render();
        },
        async copy() {
          try {
            if (!this.svg) return;
            // Plain text fallback (diagram source) if clipboard can't take HTML
            const blob = new Blob([this.svg], { type: 'image/svg+xml' });
            const item = new ClipboardItem({ 'image/svg+xml': blob });
            await navigator.clipboard.write([item]);
          } catch (err) {
            // Fallback to copying source
            await navigator.clipboard.writeText(this.svg || this.source || '');
          }
        },
        download() {
          if (!this.svg) return;
          const a = document.createElement('a');
          a.href = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(this.svg);
          a.download = 'diagram.svg';
          a.click();
        },
        onKeydown(e) {
          if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            this.render();
          }
        }
      },
      mounted() {
        this.render();
        window.addEventListener('keydown', this.onKeydown);
      },
      beforeDestroy() {
        window.removeEventListener('keydown', this.onKeydown);
      }
    });
  </script>

<script>document.write(footerTemplate);</script>
